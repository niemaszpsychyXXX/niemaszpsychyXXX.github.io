// Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASxWUgC3snryxTZXEVELfL_ftlU51mjQM",
            authDomain: "nie-masz-psychy.firebaseapp.com",
            databaseURL: "https://nie-masz-psychy-default-rtdb.firebaseio.com",
            projectId: "nie-masz-psychy",
            storageBucket: "nie-masz-psychy.appspot.com",
            messagingSenderId: "381728790253",
            appId: "1:381728790253:web:a9b3a40ab52e28a11b5ee4"
        };

        // Initialize Firebase
        let app = null;
        let db = null;
        let questionsRef = null;
        let usersRef = null;
        let usersData = {};
        let allQuestions = [];

        // Session storage for reactions
        let sessionReactions = JSON.parse(sessionStorage.getItem('reactions')) || {};

        // Available reaction emojis
        const availableReactions = {
            'like': 'üëç',
            'love': '‚ù§Ô∏è',
            'laugh': 'üòÇ',
            'wow': 'üòÆ',
            'sad': 'üò¢',
            'angry': 'üò†'
        };

        // DOM elements
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const questionAuthorFilter = document.getElementById('questionAuthor');
        const answerAuthorFilter = document.getElementById('answerAuthor');
        const dateFilter = document.getElementById('dateFilter');
        const resetFilters = document.getElementById('resetFilters');
        const activeFilters = document.getElementById('activeFilters');

        // Toggle sidebar and other existing functions remain the same
        // ...

        function processQuestionsFromFirebase(questionsData) {
            allQuestions = [];
            const questionAuthors = new Set();
            const answerAuthors = new Set();
            
            if (!questionsData || Object.keys(questionsData).length === 0) {
                displayQuestions([]);
                return;
            }
            
            Object.keys(questionsData).forEach(function(userId) {
                const userQuestions = questionsData[userId] || [];
                const answerAuthorName = usersData[userId] || 'U≈ºytkownik (' + userId.substring(0, 6) + '...)';
                answerAuthors.add(answerAuthorName);
                
                userQuestions.forEach(function(question, questionIndex) {
                    if (!question.answer || question.answer.secret || !question.answer.text || question.answer.text.trim() === '') {
                        return;
                    }
                    
                    const questionAuthorName = usersData[question.from] || 'U≈ºytkownik (' + question.from.substring(0, 6) + '...)';
                    questionAuthors.add(questionAuthorName);
                    
                    // Initialize reactions if they don't exist
                    if (!question.reactions) {
                        question.reactions = {};
                    }
                    
                    // Add Firebase path information to the question
                    allQuestions.push({
                        ...question,
                        askedTo: userId,
                        askedToName: answerAuthorName,
                        askedByName: questionAuthorName,
                        firebasePath: `questions/${userId}/${questionIndex}`  // Store the path to this question in Firebase
                    });
                });
            });
            
            // Populate dropdowns with unique authors
            populateDropdown('questionAuthor', Array.from(questionAuthors));
            populateDropdown('answerAuthor', Array.from(answerAuthors));
            
            // Sort questions by date (newest first)
            allQuestions.sort(function(a, b) {
                const timeA = a.answer.timestamp ? new Date(a.answer.timestamp.replace(/(\d{2}).(\d{2}).(\d{4})/, '$2/$1/$3')).getTime() : 0;
                const timeB = b.answer.timestamp ? new Date(b.answer.timestamp.replace(/(\d{2}).(\d{2}).(\d{4})/, '$2/$1/$3')).getTime() : 0;
                return timeB - timeA;
            });
            
            applyFilters();
        }

        function displayQuestions(questions) {
            const questionsList = document.getElementById('questionsList');
            
            if (questions.length === 0) {
                questionsList.innerHTML = '<div class="no-results">Nie znaleziono pyta≈Ñ pasujƒÖcych do wybranych filtr√≥w.</div>';
                return;
            }
            
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            questionsList.innerHTML = '';
            
            questions.forEach(function(question) {
                const qaItem = document.createElement('div');
                qaItem.className = 'qa-item';
                
                // Generate unique ID for this question/answer pair
                const questionId = `${question.askedTo}_${question.from}_${question.timestamp}`;
                
                // Create reactions HTML
                let reactionsHtml = '<div class="reactions-container">';
                
                Object.entries(availableReactions).forEach(([reactionType, emoji]) => {
                    const count = question.reactions && question.reactions[reactionType] ? question.reactions[reactionType] : 0;
                    const isActive = sessionReactions[questionId] === reactionType;
                    
                    reactionsHtml += `
                        <button class="reaction-btn ${isActive ? 'active' : ''}" 
                                data-question-id="${questionId}" 
                                data-firebase-path="${question.firebasePath}"
                                data-reaction="${reactionType}">
                            ${emoji} <span class="reaction-count">${count}</span>
                        </button>
                    `;
                });
                
                reactionsHtml += '</div>';
                
                qaItem.innerHTML = `
                    <div class="question-section">
                        <div class="question-header">
                            <span class="question-author">${question.askedByName}</span>
                            <span class="question-time">${question.timestamp || 'Brak daty'}</span>
                        </div>
                        <div class="question-content">${question.text || 'Brak tre≈õci pytania'}</div>
                    </div>
                    
                    <div class="answer-section">
                        <div class="answer-header">
                            <span class="answer-author">${question.askedToName}</span>
                            <span class="answer-time">${question.answer.timestamp || 'Brak daty'}</span>
                        </div>
                        <div class="answer-content">${question.answer.text}</div>
                        ${reactionsHtml}
                    </div>
                `;
                
                questionsList.appendChild(qaItem);
            });
            
            // Add event listeners to reaction buttons
            document.querySelectorAll('.reaction-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-question-id');
                    const reactionType = this.getAttribute('data-reaction');
                    const firebasePath = this.getAttribute('data-firebase-path');
                    
                    // Check if user already reacted to this question
                    const previousReaction = sessionReactions[questionId];
                    
                    if (previousReaction === reactionType) {
                        // User clicked the same reaction - remove it
                        removeReaction(questionId, reactionType, firebasePath);
                        this.classList.remove('active');
                    } else {
                        // User clicked a different reaction
                        if (previousReaction) {
                            // Remove previous reaction first
                            removeReaction(questionId, previousReaction, firebasePath);
                            document.querySelector(`.reaction-btn[data-question-id="${questionId}"][data-reaction="${previousReaction}"]`).classList.remove('active');
                        }
                        
                        // Add new reaction
                        addReaction(questionId, reactionType, firebasePath);
                        this.classList.add('active');
                    }
                });
            });
            
            requestAnimationFrame(function() {
                window.scrollTo(0, scrollPosition);
            });
        }
        
        function addReaction(questionId, reactionType, firebasePath) {
            // Find the question in our local data
            const question = allQuestions.find(q => 
                `${q.askedTo}_${q.from}_${q.timestamp}` === questionId
            );
            
            if (question) {
                // Initialize reactions if they don't exist
                if (!question.reactions) {
                    question.reactions = {};
                }
                
                // Increment reaction count locally
                if (!question.reactions[reactionType]) {
                    question.reactions[reactionType] = 0;
                }
                question.reactions[reactionType]++;
                
                // Update Firebase
                const updates = {};
                updates[`reactions/${reactionType}`] = question.reactions[reactionType];
                db.ref(firebasePath).update(updates)
                    .then(() => {
                        console.log('Reaction added successfully');
                    })
                    .catch(error => {
                        console.error('Error adding reaction:', error);
                        // Rollback local change if Firebase update fails
                        question.reactions[reactionType]--;
                    });
                
                // Update the UI
                const countElement = document.querySelector(`.reaction-btn[data-question-id="${questionId}"][data-reaction="${reactionType}"] .reaction-count`);
                if (countElement) {
                    countElement.textContent = question.reactions[reactionType];
                }
                
                // Store in session
                sessionReactions[questionId] = reactionType;
                sessionStorage.setItem('reactions', JSON.stringify(sessionReactions));
            }
        }
        
        function removeReaction(questionId, reactionType, firebasePath) {
            // Find the question in our local data
            const question = allQuestions.find(q => 
                `${q.askedTo}_${q.from}_${q.timestamp}` === questionId
            );
            
            if (question && question.reactions && question.reactions[reactionType]) {
                // Decrement reaction count locally
                question.reactions[reactionType]--;
                if (question.reactions[reactionType] <= 0) {
                    delete question.reactions[reactionType];
                }
                
                // Prepare Firebase update
                const updates = {};
                if (question.reactions[reactionType]) {
                    updates[`reactions/${reactionType}`] = question.reactions[reactionType];
                } else {
                    updates[`reactions/${reactionType}`] = null; // Remove if count is 0
                }
                
                // Update Firebase
                db.ref(firebasePath).update(updates)
                    .then(() => {
                        console.log('Reaction removed successfully');
                    })
                    .catch(error => {
                        console.error('Error removing reaction:', error);
                        // Rollback local change if Firebase update fails
                        if (!question.reactions[reactionType]) {
                            question.reactions[reactionType] = 0;
                        }
                        question.reactions[reactionType]++;
                    });
                
                // Update the UI
                const countElement = document.querySelector(`.reaction-btn[data-question-id="${questionId}"][data-reaction="${reactionType}"] .reaction-count`);
                if (countElement) {
                    countElement.textContent = question.reactions[reactionType] || 0;
                }
                
                // Remove from session storage
                delete sessionReactions[questionId];
                sessionStorage.setItem('reactions', JSON.stringify(sessionReactions));
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initFirebase();
        });
    </script>
